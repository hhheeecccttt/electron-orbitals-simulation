<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif; /* Changed to Arial for consistency */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px; /* Added gap for spacing between canvas and controls */
            margin: 20px;
            background-color: #f4f4f4; /* Light grey background */
        }
        #simulation-wrapper {
            border: 1px solid #ccc; /* Light grey border */
            box-shadow: 2px 2px 8px rgba(0,0,0,0.1); /* Subtle shadow */
        }
        canvas {
            background-color: #fff; /* White background for the canvas */
            display: block; /* Ensures canvas doesn't have extra space below it */
        }
        .controls {
            border: 1px solid #ccc;
            padding: 15px;
            background-color: #fff;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px; /* Spacing between control groups */
        }
        .control-group { /* General grouping for labels and inputs */
            display: flex; /* Make label and input align */
            align-items: center;
            gap: 10px; /* Space between label and input */
            /* margin-bottom: 0; Removed margin as gap handles spacing */
        }
        .control-group label {
            width: 80px; /* Fixed width for labels for alignment */
            text-align: right;
            white-space: nowrap; /* Prevent label wrapping */
        }
        .slider-output {
            margin-left: 10px;
            font-weight: bold;
            min-width: 25px; /* Ensure space for longer numbers */
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="simulation-wrapper">
        <canvas id="simulationCanvas"></canvas>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="scaleSlider">Scale:</label>
            <input type="range" id="scaleSlider" min="1" max="20" value="5">
            <span id="scaleValue" class="slider-output">5</span>
        </div>
        <div class="control-group">
            <label for="nSlider">n:</label>
            <input type="range" id="nSlider" min="1" max="5" value="3">
            <span id="nValue" class="slider-output">3</span>
        </div>
        <div class="control-group">
            <label for="lSlider">l:</label>
            <input type="range" id="lSlider" min="0" max="1" value="1">
            <span id="lValue" class="slider-output">1</span>
        </div>
        <div class="control-group">
            <label for="mSlider">m:</label>
            <input type="range" id="mSlider" min="0" max="1" value="1">
            <span id="mValue" class="slider-output">1</span>
        </div>
        <div class="control-group">
            <label for="contrastSlider">Contrast:</label>
            <input type="range" id="contrastSlider" min="10" max="200" value="40">
            <span id="contrastValue" class="slider-output">40</span>
        </div>
    </div>


    <script>
        const canvas = document.getElementById('simulationCanvas');
        const ctx = canvas.getContext('2d');

        let xDimension = 200, yDimension = 200;
        let renderedPixelSize = 5; 
        let n = 3, l = 1, m = 1;
        let a0 = 1;
        let simScale = 2; 
        let contrast = 40;

        canvas.width = xDimension * renderedPixelSize;
        canvas.height = yDimension * renderedPixelSize;

        function laguerrePolynomial(x) {
            const a = 2 * l + 1;
            const N = n - l - 1;
            let r = 0;
            for (let k = 0; k <= N; k++) {
                r += Math.pow(-1, k) / factorial(k) * factorial(N + a) / (factorial(N - k) * factorial(a + k)) * Math.pow(x, k);
            }
            return r;
        }

        function associatedLegendrePolynomial(M, L, x) {
            let base = Math.pow(-1, M) * Math.pow(1 - x * x, M / 2.0);
            for (let i = 2 * M - 1; i > 1; i -= 2) {
                base *= i;
            }
            if (M === L) {
                return base;
            } else {
                let result = Array(L + 1).fill(0);
                result[M] = base;
                result[M + 1] = base * x * (2 * M + 1);
                for (let i = M + 2; i <= L; i++) {
                    result[i] = ((2 * (i - 1) + 1) * x * result[i - 1] - ((i - 1) + M) * result[i - 2]) / (i - M);
                }
                return result[L];
            }
        }

        function radialWave(r) {
            if (r < 1e-6) r = 1e-6;
            const A = Math.pow(2.0 / (n * a0), 1.5) * Math.sqrt(factorial(n - l - 1) / (2 * n * factorial(n + l)));
            return A * Math.pow(2 * r / (n * a0), l) * Math.exp(-r / (n * a0)) * laguerrePolynomial((2 * r) / (n * a0));
        }

        function angularWave(theta, phi) {
            const legendre = associatedLegendrePolynomial(Math.abs(m), l, Math.cos(theta));
            const normalizationConstant = Math.sqrt((2 * l + 1) / (4 * Math.PI) * factorial(l - Math.abs(m)) / factorial(l + Math.abs(m)));
            if (m > 0) {
                return Math.sqrt(2) * legendre * normalizationConstant * Math.cos(m * phi);
            } else if (m < 0) {
                return Math.sqrt(2) * legendre * normalizationConstant * Math.sin(-m * phi);
            } else {
                return legendre * normalizationConstant;
            }
        }

        function factorial(fac) {
            let num = 1;
            for (let n = 1; n <= fac; n++) {
                num *= n;
            }
            return num;
        }

        function renderToImage() {
            const centerX = xDimension / 2.0;
            const centerY = yDimension / 2.0;
            const imageData = ctx.createImageData(xDimension, yDimension);
            const data = imageData.data;

            for (let x = 0; x < xDimension; x++) {
                for (let y = 0; y < yDimension; y++) {
                    const simX = (x - centerX) / simScale;
                    const simY = (y - centerY) / simScale;
                    const radius = Math.sqrt(simX * simX + simY * simY);
                    const theta = Math.atan2(simY, simX) + Math.PI / 2;
                    const phi = 0;

                    const probability = Math.pow(angularWave(theta, phi), 2) * Math.pow(radialWave(radius), 2);
                    let intensity = Math.sqrt(probability) * 255 * contrast;
                    intensity = Math.max(0, Math.min(255, intensity));
                    const index = (y * xDimension + x) * 4;
                    data[index] = intensity;
                    data[index + 1] = intensity;
                    data[index + 2] = intensity;
                    data[index + 3] = 255;
                }
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.webkitImageSmoothingEnabled = false;
            ctx.mozImageSmoothingEnabled = false;
            ctx.imageSmoothingEnabled = false;
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = xDimension;
            tempCanvas.height = yDimension;
            tempCtx.putImageData(imageData, 0, 0);

            ctx.drawImage(tempCanvas, 
                          0, 0, xDimension, yDimension, 
                          0, 0, canvas.width, canvas.height
            );
        }

        function updateSimulation() {
            renderToImage();
        }

        const scaleValueSpan = document.getElementById('scaleValue');
        const nValueSpan = document.getElementById('nValue');
        const lValueSpan = document.getElementById('lValue');
        const mValueSpan = document.getElementById('mValue');
        const contrastValueSpan = document.getElementById('contrastValue');


        document.getElementById('scaleSlider').addEventListener('input', (e) => {
            value = parseInt(e.target.value);
            simScale = value;
            scaleValueSpan.textContent = value;
            updateSimulation();
        });

        document.getElementById('nSlider').addEventListener('input', (e) => {
            n = parseInt(e.target.value);
            l = Math.min(l, n - 1);
            m = Math.min(m, l);
            document.getElementById('lSlider').max = n - 1;
            document.getElementById('mSlider').max = l;
            document.getElementById('lSlider').value = l;
            document.getElementById('mSlider').value = m;
            
            nValueSpan.textContent = n;
            lValueSpan.textContent = l;
            mValueSpan.textContent = m;
            updateSimulation();
        });

        document.getElementById('lSlider').addEventListener('input', (e) => {
            l = parseInt(e.target.value);
            m = Math.min(m, l);
            document.getElementById('mSlider').max = l;
            document.getElementById('mSlider').value = m;
            
            lValueSpan.textContent = l;
            mValueSpan.textContent = m;
            updateSimulation();
        });

        document.getElementById('mSlider').addEventListener('input', (e) => {
            m = parseInt(e.target.value);
            mValueSpan.textContent = m;
            updateSimulation();
        });

        document.getElementById('contrastSlider').addEventListener('input', (e) => {
            contrast = parseInt(e.target.value);
            contrastValueSpan.textContent = e.target.value;
            updateSimulation();
        });

        scaleValueSpan.textContent = document.getElementById('scaleSlider').value;
        nValueSpan.textContent = document.getElementById('nSlider').value;
        lValueSpan.textContent = document.getElementById('lSlider').value;
        mValueSpan.textContent = document.getElementById('mSlider').value;
        contrastValueSpan.textContent = document.getElementById('contrastSlider').value;

        updateSimulation();
    </script>
</body>
</html>